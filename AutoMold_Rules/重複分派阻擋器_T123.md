本 Thread 遵循《Threads_Common_Execution_Rules.md》之通用條款；下列僅列本 Thread 的差異規則。

# 📑 重複分派阻擋器（Non-Common Duplicate Blocker, 適用 Thread1/2/3）

> **適用範圍**：Thread1、Thread2、Thread3。  
> **不適用**：Thread4（請改用《Thread4_共號規則.md》）。

## 目的
同一班別、同一廠別、同一機台孔位下，若 `ProductId` 已經被分派且 **非共模**（`MoldPcsSeq` 相同），則不得再次分派。

## 判定範圍（班別/機台範圍）
- `FacilityId`, `ShiftDate`, `ShiftName`, `ResourceId` 必須相同

## 共模例外（仍適用於 Thread1/2/3）
- 若 `ResourceId`, `ProductId` 相同，但 `MoldPcsSeq` **不同** → 視為共模，可再次分派

## Pre-Insert 檢核 SQL（必執行，ThreadNo IN (1,2,3)）
```sql
IF @ThreadNo IN (1,2,3)
BEGIN
  -- 檢核「非共模重複」：同機台/同班別/同廠別/同 Product，且 MoldPcsSeq 相同
  IF EXISTS (
    SELECT 1
    FROM AutoMold_Temp t
    WHERE t.FacilityId  = @FacilityId
      AND t.ShiftDate   = @ShiftDate
      AND t.ShiftName   = @ShiftName
      AND t.ResourceId  = @ResourceId
      AND t.ProductId   = @ProductId
      AND t.MoldPcsSeq  = @MoldPcsSeq  -- 相同代表非共模
      AND t.ThreadNo    IN (1,2,3)
  )
  BEGIN
    -- 不可分派，換下一筆候選資料
    GOTO NEXT_CANDIDATE;
  END
END
```


## 差異化規則
- 是否允許共模：
- 特殊候選條件：
- 其他補充：
