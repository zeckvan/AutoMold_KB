# ğŸ“‘ AutoMold_Thread4 è‡ªå‹•æ’æ¨¡æ’ç”¢é‚è¼¯å››ï¼ˆç´°éƒ¨è¦å‰‡ï¼‰

## 1. AutoMold_ArticleMoldã€å‹é«”æ¨¡å…· size æ¬ æ•¸ã€‘è³‡æ–™å–å¾—æ–¹å¼
- **ä¾†æºè¡¨**ï¼š`AutoMold_ArticleMold`  
- **ç¯©é¸æ¢ä»¶**ï¼š  
  - `SumBodySizeNeed > 0` ï¼ˆå‹é«” Size æ¬ æ•¸å¤§æ–¼ 0ï¼‰  
  - `å»ºè­°ä¸Šæ¨¡å¡Šæ•¸ âˆ’ å¯¦éš›æ’ç­ä¸Šæ¨¡æ•¸ > 0`  
- **æ’åº**ï¼šä¾ `SortMold` ç”±å°åˆ°å¤§  

---

## 2. AutoMold_ArticleMoldã€å‹é«”æ¨¡å…· Size æ¬ æ•¸ã€‘è³‡æ–™è™•ç†æ–¹å¼
- **è‹¥ç„¡è³‡æ–™**ï¼š  
  1. ç¢ºèª `AutoMold_ProductionScheduleDay`ï¼ˆç”Ÿç”¢æ’ç­æ—¥è³‡è¨Šï¼‰æ˜¯å¦ä»æœ‰æœªè™•ç†è³‡æ–™ã€‚  
  2. è‹¥æœ‰ â†’ å–å¾—ä¸‹ä¸€ç­†ç”Ÿç”¢æ’ç­æ—¥è³‡è¨Šï¼Œé‡è¤‡åŸ·è¡Œã€Œæ’æ¨¡æ’ç”¢äº”é …é‚è¼¯ã€ã€‚  
  3. è‹¥ç„¡ â†’ çµæŸæ’æ¨¡æ’ç”¢é‚è¼¯ã€‚  

- **è‹¥æœ‰è³‡æ–™**ï¼š  
  - é€ç­†è™•ç†ä»¥ä¸‹é‚è¼¯ï¼š  
    1. æª¢æŸ¥ **AutoMold_WorkMoldã€å·¥å–®éœ€æ±‚ä¸Šæ¨¡æ•¸ã€‘**  
    2. é€²å…¥å¾ŒçºŒæ’æ¨¡æ’ç”¢æµç¨‹ã€‚  

---

## 3. AutoMold_WorkMoldã€å·¥å–®éœ€æ±‚ä¸Šæ¨¡æ•¸ã€‘è³‡æ–™å–å¾—æ–¹å¼
- **ä¾†æºè³‡æ–™è¡¨**ï¼š`AutoMold_WorkMold`  
- **æ¢ä»¶**ï¼š
  - `AutoMold_WorkMold.æœªæ’æ¨¡æ’ç”¢æ•¸ > 0`  
  - `AutoMold_WorkMold.å·¥å–®æ’åº in (AutoMold_ArticleMold.å·¥å–®åºé›†åˆ)`  
- **æ’åº**ï¼š`å·¥å–®æ’åº` ç”±å°åˆ°å¤§  
- **é™åˆ¶**ï¼šå·²è™•ç†ç­†æ•¸ â‰¤ `AutoMold_ArticleMold.å»ºè­°ä¸Šæ¨¡å¡Šæ•¸`  

---

## 4. æ’æ¨¡é‚è¼¯ä¸»æµç¨‹

### 4.1 æ‰¾å°‹ AutoMold_WorkMoldã€å·¥å–®éœ€æ±‚ä¸Šæ¨¡æ•¸ã€‘è³‡è¨Šçµæœ
- **è‹¥æ‰¾åˆ°** â†’ é€²è¡Œ **AutoMold_Temp å…±è™Ÿæƒ…å¢ƒæª¢æŸ¥**  
- **è‹¥æœªæ‰¾åˆ°** â†’ çµæŸè©²ç­†è³‡æ–™è™•ç†  

---

### 4.2 æª¢æŸ¥ AutoMold_Tempã€å·²æ’æ¨¡æ’ç”¢ã€‘æ˜¯å¦æœ‰ç¬¦åˆå…±è™Ÿæƒ…å¢ƒ
- **ä¾†æºè³‡æ–™**ï¼š`BMoldS`, `AutoMold_Temp`  
- **æ¢ä»¶**ï¼š
  - `BMoldS.ZZGENDER = AutoMold_WorkMold.ZZGENDER`  
  - `BMoldS.COMPONENT = AutoMold_WorkMold.ZZPARTNO`  
  - `BMoldS.ProductSize = AutoMold_WorkMold.ProductSize`  
  - `BMoldS.MoldNo = AutoMold_WorkMold.MoldNo`  
  - `BMoldS.UniversalState <> 4`  
  - `AutoMold_Temp.ProductId = BMoldS.ProductId`  
  - `AutoMold_Temp.ç­åˆ¥ = AutoMold_ProductionScheduleDay.shift_name`  
  - `AutoMold_Temp.æ’ç­æ—¥ = AutoMold_ProductionScheduleDay.shift_date`  
  - `æ’é™¤å·²ç¶“ç”¨éçš„æ¨¡ç©´ï¼šå¦‚æœ AutoMold_Temp è£¡é¢å·²ç¶“å­˜åœ¨ç›¸åŒçš„ ProductId + MoldPcsSeq + shift_date + shift_name â†’ å°±ä¸èƒ½å†ç”¨ã€‚`
- **æ’åºé‚è¼¯**ï¼š  
  - `select top 1 â†’ åªå–å‡ºç¬¬ä¸€ç­†ç¬¦åˆæ¢ä»¶çš„æ¨¡ç©´ã€‚`
- **SQL**ï¼š
  ```sql
  select top 1
    a.ProductId,
    a.MoldPcsSeq
  from BMoldS a
  join AutoMold_Temp d on 
            d.ProductId = b.ProductId and 
            d.shift_date = AutoMold_ProductionScheduleDay.shift_date and 
            d.shift_name = AutoMold_ProductionScheduleDay.shift_name
  where a.ProductSize = AutoMold_WorkMold.ProductSize
  and a.COMPONENT= AutoMold_WorkMold.ZZPARTNO
  and a.MoldNo = AutoMold_WorkMold.MoldNo
  and a.ZZGENDER = AutoMold_WorkMold.ZZGENDER
  and not exists(
      select 1
      from AutoMold_Temp b
      where b.ProductId = a.ProductId
      and b.MoldPcsSeq = a.MoldPcsSeq	
      and b.shift_date = d.shift_date
      and b.shift_name = d.shift_name									
    )
  ```
- **å®šç¾©**ï¼šåœ¨æŸä¸€å¤©ã€æŸå€‹ç­åˆ¥è£¡ï¼Œæ‰¾å‡ºç¬¦åˆå°ºå¯¸ã€é›¶ä»¶ã€æ¨¡å…·ç·¨è™Ÿã€æ€§åˆ¥çš„æ¨¡å…·è³‡è¨Šï¼Œä¸¦å¾æœªä½¿ç”¨éçš„æ¨¡ç©´ä¸­æŒ‘ç¬¬ä¸€å€‹å¯ç”¨çš„æ¨¡ç©´ï¼Œæ‹¿ä¾†åšæ’ç”¢ã€‚

#### è™•ç†é‚è¼¯
- **è‹¥æ‰¾åˆ°**ï¼š  
  - é€²å…¥ **6. å¯«å…¥æ’æ¨¡æ’ç”¢é‚è¼¯**  

- **è‹¥æœªæ‰¾åˆ°**ï¼š  
  - é€²å…¥ **å…±æ¨¡æƒ…å¢ƒæª¢æŸ¥**  

---

### 4.3 æ‰¾å°‹ AutoMold_Tempã€å·²æ’æ¨¡æ’ç”¢ã€‘æ˜¯å¦æœ‰ç¬¦åˆå…±æ¨¡æƒ…å¢ƒ
- **ä¾†æºè³‡æ–™**ï¼š`BMoldS`, `AutoMold_Temp`  
- **æ¢ä»¶**ï¼š
  - `BMoldS.ZZGENDER = AutoMold_WorkMold.ZZGENDER`  
  - `BMoldS.COMPONENT = AutoMold_WorkMold.ZZPARTNO`  
  - `BMoldS.ProductSize = AutoMold_WorkMold.ProductSize`  
  - `BMoldS.MoldNo = AutoMold_WorkMold.MoldNo`  
  - `BMoldS.UniversalState <> 4`  
  - `AutoMold_Temp.ProductId = BMoldS.ProductId`  
  - `AutoMold_Temp.MoldPcsSeq = BMoldS.MoldPcsSeq`  
  - `AutoMold_Temp.shift_name = AutoMold_ProductionScheduleDay.shift_name`  
  - `AutoMold_Temp.shift_date = AutoMold_ProductionScheduleDay.shift_date`  
  - `isnull(BmoldS.CoMoldMk,'') <> 'Y'`  
  - `exists(select 1 from moldS a where a.ProductId = moldS.ProductId and a.MoldPcsSeq = moldS.MoldPcsSeq and isnull(a.CoMoldMk,'') = 'Y' and a.UniversalState <> 4)`  
- **SQL**ï¼š
  ```sql
  select distinct 
    @resource = b.ResourceId ,
    @productid = a.ProductId,
    a.MoldPcsSeq,
    a.MoldPcsQty		
  from BMoldS a
  join AutoMold_Temp  b on 
              a.ProductId = b.ProductId 
              and a.MoldPcsSeq = b.MoldPcsSeq
              and b.shift_date = AutoMold_ProductionScheduleDay.shift_date
              and b.shift_name = AutoMold_ProductionScheduleDay.shift_name								
  where a.ProductSize = AutoMold_WorkMold.ProductSize
  and a.COMPONENT= AutoMold_WorkMold.ZZPARTNO
  and a.MoldNo = AutoMold_WorkMold.MoldNo
  and a.ZZGENDER = AutoMold_WorkMold.ZZGENDER
  and isnull(a.CoMoldMk,'') <> 'Y' 
  and exists(
        select 1 
        from BMoldS c
        where c.ProductId = a.ProductId
        and c.MoldPcsSeq = a.MoldPcsSeq
        and isnull(c.CoMoldMk,'') = 'Y' 
      )
  ```
#### è™•ç†é‚è¼¯
1. ç¢ºèª `AutoMold_Temp.ResourceId` æ˜¯å¦ä»æœ‰å‰©é¤˜æˆ°åŠ›ï¼š
      - å®šç¾©ï¼š`åœ¨æŒ‡å®šçš„æ—¥æœŸèˆ‡ç­åˆ¥è£¡ï¼Œæª¢æŸ¥æŸä¸€å°æ©Ÿå°ï¼Œå¦‚æœå®ƒçš„ã€Œæœ€å°å‰©é¤˜æˆ°åŠ›ã€é‚„å¤§æ–¼ 0ï¼Œå°±è¡¨ç¤ºé€™å°æ©Ÿå°é‚„èƒ½ç¹¼çºŒæ’ç”¢ã€‚`
      - SQLï¼š
        ```sql
        SELECT 
            @resourceid = AutoMold_Temp.ResourceId,
            @shift_work_hour  = MIN(AutoMold_Temp.MoldworkN)          -- è©²æ©Ÿå°æœ€å°çš„å‰©é¤˜æˆ°åŠ›
        FROM AutoMold_Temp
        WHERE shift_date = AutoMold_ProductionScheduleDay.shift_date               -- æŒ‡å®šæ—¥æœŸ
          AND shift_name   = AutoMold_ProductionScheduleDay.shift_name             -- æŒ‡å®šç­åˆ¥
          AND ResourceId = @resource
        GROUP BY ResourceId
        HAVING MIN(MoldworkN) > 0                 -- æ©Ÿå°å¿…é ˆé‚„æœ‰å¯ç”¨ç”¢èƒ½ (>0)        
        ```
2. è‹¥ `@shift_work_hour > 0` â†’ éœ€æª¢æŸ¥æ˜¯å¦ç‚ºæœ€å¾Œä¸€ç­†ä¸Šæ¨¡åº  
   - SQL1ï¼ˆåŒæ¨¡å…·æœ€å¤§ä¸Šæ¨¡åºï¼‰ :
     ```sql
      select @compare1 = max(ä¸Šæ¨¡åº)
      from AutoMold_Temp
      where 
      AutoMold_Temp.ResourceId  = @resourceid and 
      AutoMold_Temp.ProductId = @productid and 
      AutoMold_Temp.Shift_Name = AutoMold_ProductionScheduleDay.shift_name and 
      AutoMold_Temp.shift_date  =AutoMold_ProductionScheduleDay.shift_date
     ```          
   - SQL2ï¼ˆä¸åŒæ¨¡å…·æœ€å¤§ä¸Šæ¨¡åºï¼‰:  
     ```sql
      select @compare2 = max(ä¸Šæ¨¡åº)
      from AutoMold_Temp
      where 
      AutoMold_Temp.ResourceId  = @resourceid and 
      AutoMold_Temp.ProductId <> @productid and 
      AutoMold_Temp.Shift_Name = AutoMold_ProductionScheduleDay.shift_name and 
      AutoMold_Temp.shift_date  =AutoMold_ProductionScheduleDay.shift_date
     ```    
   - å…¶å®ƒæ¢ä»¶:`å¦‚æœ@compare2ç‚ºç©ºï¼Œé è¨­å¸¶ 0`
   - åˆ¤æ–· `@compare1 > @compare2` â†’ æ‰èƒ½æ¥çºŒæ’å…¥å…±æ¨¡æ©Ÿå°  

3. è‹¥ç¬¦åˆæ¢ä»¶ï¼š  
    - é€²å…¥ **6. å¯«å…¥æ’æ¨¡æ’ç”¢é‚è¼¯**  

4. è‹¥æœªæ‰¾åˆ° â†’ é€²å…¥ **å‰ç­å­”ä½æ©Ÿå°æª¢æŸ¥**  

---

### 4.4 æ‰¾å°‹ AutoMold_Produceã€å‰ç­å­”ä½æ©Ÿå°ã€‘
- **ä¾†æºè³‡æ–™**ï¼š`AutoMold_Produce`  
- **æ¢ä»¶**ï¼š
  - `MoldNo = AutoMold_ArticleMold.MoldNo`  
  - æ’é™¤å·²å­˜åœ¨æ–¼ `AutoMold_Temp` çš„ ResourceId  
  - `å¯¦éš›å·¥æ™‚ âˆ’ ç¶­ä¿æ™‚æ•¸ âˆ’ æ›æ¨¡æ™‚æ•¸ > 0`  

- **SQL**ï¼š
  ```sql
  SELECT TOP 1 
  @resource = x_rescourse,
  @thread4_seq = x_seq
  FROM (
    select 
    x_rescourse = a.ResourceId  ,
    x_seq= 1
    from AutoMold_Produce a
    where a.MoldNo =  AutoMold_ArticleMold.MoldNo and
          a.Shift_Name = AutoMold_ProductionScheduleDay.shift_name and 
          a.shift_date = AutoMold_ProductionScheduleDay.shift_dat
      not exists(select 1
      from AutoMold_temp b
      where b.ResourceId = a.ResourceId and
      b.Shift_Name = AutoMold_ProductionScheduleDay.shift_name and 
      b.shift_date = AutoMold_ProductionScheduleDay.shift_date)
  ) AS CombinedResults
  ORDER BY x_seq,x_rescourse
  ```

- **è™•ç†é‚è¼¯**ï¼š

    - é€²å…¥ **6. å¯«å…¥æ’æ¨¡æ’ç”¢é‚è¼¯**  

- **è‹¥æœªæ‰¾åˆ° â†’ é€²å…¥ å·²æ’æ¨¡å‰©é¤˜æˆ°åŠ›æª¢æŸ¥**

---

### 4.5 æ‰¾å°‹ AutoMold_Tempã€å·²æ’æ¨¡æ’ç”¢ã€‘å‰©é¤˜æˆ°åŠ›æ©Ÿå°

- **ä¾†æºè³‡æ–™**ï¼šAutoMold_Temp

- **æ¬„ä½**ï¼š

  - @resourceid = AutoMold_Temp.ResourceId
  - @shift_work_hour = min(AutoMold_Temp.MoldworkN)

- **æ¢ä»¶**ï¼š
    - AutoMold_Temp.Shift_Date = AutoMold_ProductionScheduleDay.Shift_Date
    - AutoMold_Temp.Shift_Name = AutoMold_ProductionScheduleDay.Shift_Name    
    - group by AutoMold_Temp.ResourceId
    - having min(AutoMold_Temp.MoldworkN) - @mold_change > 0
    - order by  min(MoldworkN)  - @mold_change 

- **SQL**ï¼š
    ```sql
    WITH R AS (
        SELECT
            t.ResourceId,
            MIN(t.MoldworkN) AS MinWorkN,
            MIN(t.MoldworkN) - @mold_change AS EffectiveWorkHour
        FROM AutoMold_Temp t
        WHERE t.Shift_Date = AutoMold_ProductionScheduleDay.Shift_Date
        AND t.Shift_Name = AutoMold_ProductionScheduleDay.Shift_Name
        GROUP BY t.ResourceId
        HAVING MIN(t.MoldworkN) - @mold_change > 0
    )
    SELECT TOP (1)
        @resourceid       = R.ResourceId,
        @shift_work_hour  = R.MinWorkN
    FROM R
    ORDER BY
        R.EffectiveWorkHour ASC,
        R.ResourceId ASC;
        ;
    ```

- **å®šç¾©**ï¼šã€Œåœ¨åŒä¸€å¤©ã€åŒä¸€ç­åˆ¥è£¡ï¼ŒæŒ‘å‡ºä¸€å°æ©Ÿå°ï¼Œåœ¨è€ƒæ…® æ›æ¨¡è€—æ™‚ (@mold_change) ä¹‹å¾Œï¼Œé‚„æœ‰ç”¢èƒ½å¯ç”¨ï¼Œä¸¦ä¸”æ˜¯ æœ€åˆé© çš„æ©Ÿå°ã€‚ã€

- **è™•ç†é‚è¼¯**ï¼š

  - è‹¥æ‰¾åˆ° â†’ é€²å…¥ **6. å¯«å…¥æ’æ¨¡æ’ç”¢é‚è¼¯**  

  - è‹¥æœªæ‰¾åˆ° â†’ é€²å…¥ **æ‰¾å°‹åŒç”¢å“ Resource æ˜¯å¦æœ‰å¯ç”¨æ©Ÿå°**

  ---


### 4.6 æ‰¾å°‹åŒç”¢å“ Resource æ˜¯å¦æœ‰å¯ç”¨æ©Ÿå°

- ä¾†æºè³‡æ–™ï¼šCoreDataModel.T_Resource, T_Area, T_Facility, T_ResourceService, T_Service, T_Step

- SQL æ¢ä»¶ï¼š

```sql
select 
	@resource = a.name
from CoreDataModel.T_Resource a
join CoreDataModel.T_Area b on 
				a.[Type] = b.ProductType and 
				a.DataGroupId = b.DataGroupId and 
				b.ProductType =  @BAutoMoldFilter.ProductTand
				b.Type = 'Resource' and
				b.AreaId = @BautoMoldFilter.Product.AreaId
join CoreDataModel.T_Facility c on
					c.FacilityId = b.FacilityId and 
					c.FacilityId =  @BautoMoldQueue.FacilityId	
join CoreDataModel.T_ResourceService f on 
					f.SourceEntityId = a.ResourceId 															
join CoreDataModel.T_Service d on
					d.ServiceId = f.TargetEntityId 
join CoreDataModel.T_Step e on e.StepId = @BautoMoldFilter.StepId and
				     e.name = d.name
where not exists(
			select 1 
			from AutoMold_Temp d 
			where  d.æ©Ÿå°å­”ä½ä»£ç¢¼ = a.name
			and d.æ’ç­æ—¥ = @shift_date
			and d.ç­åˆ¥ = @shift_name)
and a.universalstate <> 4
order by a.ResourceGroup,a.name		
```

- è™•ç†é‚è¼¯ï¼š

  - è‹¥æ‰¾åˆ° â†’ é€²å…¥ **6. å¯«å…¥æ’æ¨¡æ’ç”¢é‚è¼¯**  

  - è‹¥æœªæ‰¾åˆ° â†’ è¿”å› `AutoMold_ArticleMold`ï¼Œè™•ç†ä¸‹ä¸€ç­† size æ¬ æ•¸

  ---

## 5. æ©Ÿå°é¤˜åŠ›åˆ†æ´¾ï¼ˆç›¸åŒæ¢ä»¶å·¥å–®ï¼‰
-   **ä¾†æºè¡¨**ï¼š`AutoMold_WorkMold`

-   **æ¢ä»¶**ï¼š

    -   `AufnrSeq âˆˆ AutoMold_ArticleMold.SortOrderList`
    -   `UnmoldedQuantity > 0`

-   **æ’åº**ï¼šä¾ `AufnrSeq` ç”±å°åˆ°å¤§

-   **SQL åƒè€ƒ**ï¼š

    ``` sql
    SELECT *
    FROM AutoMold_WorkMold 
    WHERE AufnrSeq IN AutoMold_ArticleMold.SortOrderList 
      AND UnmoldedQuantity > 0 
    ORDER BY AufnrSeq ASC;
    ```

-   **è™•ç†é‚è¼¯**ï¼š

    -   é€ç­†å¯«å…¥ `AutoMold_Temp`
    -   æ›´æ–° `AutoMold_ArticleMold`ï¼ˆåŒä¸Šè¦å‰‡ï¼‰
    -   æ›´æ–° `AutoMold_WorkMold`ï¼ˆåŒä¸Šè¦å‰‡ï¼‰
    -   æŒçºŒåˆ†æ´¾ç›´åˆ°
        `AutoMold_Temp.WorkQty - AutoMold_Temp.ShiftWorkQty = 0`ï¼ˆæˆ°åŠ›è€—ç›¡ï¼‰

  ---

## 6. å¯«å…¥æ’æ¨¡æ’ç”¢é‚è¼¯
  - æ–°å¢è³‡æ–™è‡³ `AutoMold_Temp`  
  - æ›´æ–° `AutoMold_ArticleMold`ï¼š
    - æ¬„ä½ï¼š 
        -   `SumBodySizeNeed -= AutoMold_Temp.ShiftWorkQty`
        -   `ActualRequiredUpperMoldQuantity += 1`
    - æ¢ä»¶ï¼š
        -   `SortMold = AutoMold_ArticleMold.SortMold`     
  - æ›´æ–° `AutoMold_WorkMold`ï¼š
    - æ¬„ä½ï¼š   
        -   `MoldedQuantity += AutoMold_Temp.ShiftWorkQty`
        -   `UnmoldedQuantity = GAMNG âˆ’ MoldedQuantity`
    - æ¢ä»¶ï¼š
        -   AufnrSeq = 
        ``` sql
        SELECT TOP 1 AutoMold_WorkMold.AufnrSeq
        FROM AutoMold_WorkMold 
        WHERE AufnrSeq IN AutoMold_ArticleMold.SortOrderList 
          AND UnmoldedQuantity > 0 
        ORDER BY AufnrSeq ASC;
        ```              
  - è‹¥ AutoMold_Temp.WorkQty - AutoMold_Temp.ShiftWorkQty > 0 é€²å…¥ **5. æ©Ÿå°é¤˜åŠ›åˆ†æ´¾ï¼ˆç›¸åŒæ¢ä»¶å·¥å–®ï¼‰**  

  ---

## 7. çµæŸæ¢ä»¶
-   ç•¶ **å‹é«” Size æ¬ æ•¸** å·²å®Œå…¨è™•ç†ï¼Œæˆ–
    **æ‰€æœ‰æ©Ÿå°ç„¡æˆ°åŠ›å¯å†åˆ†æ´¾**ï¼Œå‰‡ï¼š
    -   è‹¥æœ‰ä¸‹ä¸€ç­† `AutoMold_ArticleMold` â†’ è¿”å› **æ­¥é©Ÿ 1**
    -   è‹¥ç„¡ â†’ è¿”å› **æ­¥é©Ÿ 2** åˆ¤æ–·æ˜¯å¦æ›ä¸‹ä¸€ç­†ç”Ÿç”¢æ’ç­æ—¥
    -   è‹¥ä¹Ÿç„¡ â†’ **çµæŸæ•´é«”é‚è¼¯**
